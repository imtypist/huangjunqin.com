<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
 <!--  
 -->
  
  <title>fat12文件系统实现原理 | 黄俊钦</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<!--   <meta name="description" content="​ 文件说明image/ : fat12格式测试文件 DiskLib.[h|lib|dll] : 动态链接库文件 fat12/ : FAT12动态链接库目录 fat12_test/ : 测试程序目录 fat12引导扇区字段说明">
<meta property="og:type" content="article">
<meta property="og:title" content="fat12文件系统实现原理">
<meta property="og:url" content="https://blog.huangjunqin.com/2017/06/13/fat12/index.html">
<meta property="og:site_name" content="黄俊钦">
<meta property="og:description" content="​ 文件说明image/ : fat12格式测试文件 DiskLib.[h|lib|dll] : 动态链接库文件 fat12/ : FAT12动态链接库目录 fat12_test/ : 测试程序目录 fat12引导扇区字段说明">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-08-29T14:20:55.164Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="fat12文件系统实现原理">
<meta name="twitter:description" content="​ 文件说明image/ : fat12格式测试文件 DiskLib.[h|lib|dll] : 动态链接库文件 fat12/ : FAT12动态链接库目录 fat12_test/ : 测试程序目录 fat12引导扇区字段说明"> -->
  
    <link rel="alternate" href="/atom.xml" title="黄俊钦" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
<!--   
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
   -->
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">黄俊钦</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">科研，在路上</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
          <a class="main-nav-link" href="https://huangjunqin.com">About</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.huangjunqin.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-fat12" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/06/13/fat12/" class="article-date">
  <time datetime="2017-06-13T12:46:25.000Z" itemprop="datePublished">2017-06-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      fat12文件系统实现原理
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>​<iframe src="https://ghbtns.com/github-btn.html?user=imtypist&repo=fat12&type=star&count=true" frameborder="0" scrolling="0" width="90px" height="20px"></iframe><iframe src="https://ghbtns.com/github-btn.html?user=imtypist&repo=fat12&type=fork&count=true" frameborder="0" scrolling="0" width="170px" height="20px"></iframe></p>
<h3 id="文件说明"><a href="#文件说明" class="headerlink" title="文件说明"></a>文件说明</h3><p><code>image/</code> : fat12格式测试文件</p>
<p><code>DiskLib.[h|lib|dll]</code> : 动态链接库文件</p>
<p><code>fat12/</code> : FAT12动态链接库目录</p>
<p><code>fat12_test/</code> : 测试程序目录</p>
<h3 id="fat12引导扇区字段说明"><a href="#fat12引导扇区字段说明" class="headerlink" title="fat12引导扇区字段说明"></a>fat12引导扇区字段说明</h3><a id="more"></a>
<table>
<thead>
<tr>
<th>名称</th>
<th>偏移(BYTE)</th>
<th>长度(BYTE)</th>
<th>内容</th>
<th>软盘参考值</th>
</tr>
</thead>
<tbody>
<tr>
<td>BS_jmpBoot</td>
<td>0</td>
<td>3</td>
<td>-</td>
<td>jmp LABEL_START &amp;&amp; nop</td>
</tr>
<tr>
<td>BS_OEMName</td>
<td>3</td>
<td>8</td>
<td>厂商名</td>
<td>‘Forrest Y’</td>
</tr>
<tr>
<td>BPB_BytsPerSec</td>
<td>11</td>
<td>2</td>
<td>每扇区字节数</td>
<td>0x200(512字节)</td>
</tr>
<tr>
<td>BPB_SecPerClus</td>
<td>13</td>
<td>1</td>
<td>每簇扇区数</td>
<td>0x01</td>
</tr>
<tr>
<td>BPB_RsvdSecCnt</td>
<td>14</td>
<td>2</td>
<td>Boot记录占用多少</td>
<td>0x01</td>
</tr>
<tr>
<td>BPB_NumFATs</td>
<td>16</td>
<td>1</td>
<td>共有多少FAT表</td>
<td>0x02</td>
</tr>
<tr>
<td>BPB_RootEntCnt</td>
<td>17</td>
<td>2</td>
<td>根目录文件数最大值</td>
<td>0xE0(224)</td>
</tr>
<tr>
<td>BPB_TotSec16</td>
<td>19</td>
<td>2</td>
<td>扇区总数</td>
<td>0xB40(2280)</td>
</tr>
<tr>
<td>BPB_Media</td>
<td>21</td>
<td>1</td>
<td>介质描述符</td>
<td>0xF0</td>
</tr>
<tr>
<td>BPB_FATSz16</td>
<td>22</td>
<td>2</td>
<td>每FAT扇区数</td>
<td>0x09</td>
</tr>
<tr>
<td>BPB_SecPerTrk</td>
<td>24</td>
<td>2</td>
<td>每磁道扇区数</td>
<td>0x12</td>
</tr>
<tr>
<td>BPB_NumHeads</td>
<td>26</td>
<td>2</td>
<td>磁头数</td>
<td>0x02</td>
</tr>
<tr>
<td>BPB_HiddSec</td>
<td>28</td>
<td>4</td>
<td>隐藏扇区数</td>
<td>0</td>
</tr>
<tr>
<td>BPB_TotSec32</td>
<td>32</td>
<td>4</td>
<td>如果BPB_TotSec16是0，由这个值记录扇区数</td>
<td>0xB40(2280)</td>
</tr>
<tr>
<td>BS_DrvNum</td>
<td>36</td>
<td>1</td>
<td>中断13的驱动器号</td>
<td>0</td>
</tr>
<tr>
<td>BS_Reserved1</td>
<td>37</td>
<td>1</td>
<td>未使用</td>
<td>0</td>
</tr>
<tr>
<td>BS_BootSig</td>
<td>38</td>
<td>1</td>
<td>扩展引导标记</td>
<td>0x29</td>
</tr>
<tr>
<td>BS_VolD</td>
<td>39</td>
<td>4</td>
<td>卷序列号</td>
<td>0</td>
</tr>
<tr>
<td>BS_VolLab</td>
<td>43</td>
<td>11</td>
<td>卷标</td>
<td>‘OrangeS0.02’</td>
</tr>
<tr>
<td>BS_FileSysType</td>
<td>54</td>
<td>8</td>
<td>文件系统类型</td>
<td>‘FAT12’</td>
</tr>
<tr>
<td>引导代码</td>
<td>62</td>
<td>448</td>
<td>引导代码、数据及其他填充字符等</td>
<td></td>
</tr>
<tr>
<td>结束标志</td>
<td>510</td>
<td>2</td>
<td></td>
<td>0xAA55</td>
</tr>
</tbody>
</table>
<h3 id="fat1"><a href="#fat1" class="headerlink" title="fat1"></a>fat1</h3><p>​    在偏移512字节处开始（即200h），每个fat项占用12bit，fat表开始3个字节不用于用户文件分配，也就是占用了0簇和1簇，所以用户的数据从簇2开始分配。</p>
<p>​    Fat表从头开始按3字节分成一组，一组中第2字节的低半字节作为最高半字节和一组中第1字节组成整数表示一个簇号，第2字节的高半字节作为最低半字节和第3字节组成整数表示一个簇号。</p>
<p>​    我们只需要知道一个文件的首簇号，根据该簇号内容指向的下一个簇号寻找，直到遇到簇号对应内容为0xfff则停止索引，说明已经到了文件末尾。</p>
<h3 id="根目录表字段说明"><a href="#根目录表字段说明" class="headerlink" title="根目录表字段说明"></a>根目录表字段说明</h3><table>
<thead>
<tr>
<th>名称</th>
<th>偏移</th>
<th>长度</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>DIR_Name</td>
<td>0</td>
<td>0xB</td>
<td>文件名8个字节，扩展名3个字节，文件名不够8字节用空格0x20填充</td>
</tr>
<tr>
<td>DIR_Attr</td>
<td>0xB</td>
<td>1</td>
<td>文件属性，卷标项是0x28，文件项是0x20，目录是0x10</td>
</tr>
<tr>
<td>保留</td>
<td>0xC</td>
<td>10</td>
<td></td>
</tr>
<tr>
<td>DIR_WrtTime</td>
<td>0x16</td>
<td>2</td>
<td>最后修改时间</td>
</tr>
<tr>
<td>DIR_WrtDate</td>
<td>0x18</td>
<td>2</td>
<td>最后修改日期</td>
</tr>
<tr>
<td>DIR_FstClus</td>
<td>0x1A</td>
<td>2</td>
<td>此条目对应开始的簇号</td>
</tr>
<tr>
<td>DIR_FileSize</td>
<td>0x1C</td>
<td>4</td>
<td>文件大小</td>
</tr>
</tbody>
</table>
<h3 id="如何寻找首簇号"><a href="#如何寻找首簇号" class="headerlink" title="如何寻找首簇号"></a>如何寻找首簇号</h3><p>​    <code>根目录起始地址：1(boot区大小)+2(fat数)*9(fat的扇区数)*512(扇区大小)=0x2600h</code> </p>
<p>​    从boot记录获取根区记录数，缺省224条。读出所有记录，每条记录32字节，其开始字段为文件名，比较文件名匹配则找到记录，从首簇字段（偏1ah处）获得首簇号。</p>
<h3 id="如何定位多级目录"><a href="#如何定位多级目录" class="headerlink" title="如何定位多级目录"></a>如何定位多级目录</h3><p>​    e.g. <code>a:\tem\tem.txt</code></p>
<p>​    目录tem作为一个目录项存储在根目录区中。这样可找到tem目录，且<strong>目录项属性应该不是文件</strong>（0x20），而是其它。于是可以继续查找。</p>
<p>​    目录tem本身存储为一个文件，和根目录区一样格式，由32字节的目录项组成。这样tem下的不论是文件还是子目录均由一个目录项登记。而tem目录文件的大小可以随意（不同于根目录），因为文件存储空间可以用fat表的簇链来表示。这样找tem目录项后，从首簇字段获取到tem的目录文件（即类似根目录表），遍历其中的32字节目录项，<strong>查找是否存在某个文件或目录即可</strong>。  如此，即可形成多层次的目录嵌套。</p>
<p>​    先来看看fat12格式文件系统的格式：</p>
<table>
<thead>
<tr>
<th style="text-align:center">数据区（长度非固定）</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">根目录区（长度非固定）</td>
</tr>
<tr>
<td style="text-align:center">FAT12（9扇区）</td>
</tr>
<tr>
<td style="text-align:center">FAT12（9扇区）</td>
</tr>
<tr>
<td style="text-align:center">引导扇区（1扇区）</td>
</tr>
</tbody>
</table>
<p>​    可以计算得出，根目录区的起始地址为<code>（1+9+9）*512=0x2600h</code>，假定根目录区大小为0x1c00（软盘缺省值224*32Bytes），则数据区起始偏移为<code>0x2600+0x1c00=0x4200</code>。</p>
<p>​    又例如：Mytxt.txt的簇号为5，减去开始两个号分配给系统对用户区而言，实际是第4个簇（簇号为3）。前面已知用户数据区从0x4200开始，那么，文件实际起始偏移是<code>0x4200+3*512 = 0x4800</code>。</p>
<h3 id="“-”和”-”"><a href="#“-”和”-”" class="headerlink" title="“.”和”..”"></a>“.”和”..”</h3><p>​    空目录下会有两个目录项，一个是“.”，即2E，一个是“..”，即2E2E，代表了当前目录和上级目录。“.”是当前目录的别名，首簇就应该指向自己，而“..”首簇就改指向上级目录文件的首簇。如果上级目录是根目录，根目录区并没有在用户数据区分配内容。如何填写其簇号呢？其实只要让系统明白这是根目录即可。既然用户簇从2开始（其实这正是从2开始的原因，将特殊簇号留给特殊条目），用0或1作为根目录代表都可以，从实际看，用0代表根目录。</p>
<h3 id="总结文件查找算法"><a href="#总结文件查找算法" class="headerlink" title="总结文件查找算法"></a>总结文件查找算法</h3><p>1、先查看根目录区，是否有匹配的目录，如果有，通过对应目录项的首簇段获取其目录文件的首簇号。</p>
<p>2、通过fat表获得该目录文件的全部内容，遍历该文件，一次偏移32字节继续查找目录项，匹配查询路径中对应的项。如果查到则类似1，2查找对应的目录文件及目录项，否则说明找不到，结束。</p>
<p>3、如果在倒数第一层目录文件中找到了被查文件的目录项，从中获取首簇号，即可通过fat表访问该文件整个相关簇。</p>
<h3 id="删除一个文件"><a href="#删除一个文件" class="headerlink" title="删除一个文件"></a>删除一个文件</h3><p>​    目录项第一个字节修改为E5代表删除。</p>
<h3 id="回收已用的簇"><a href="#回收已用的簇" class="headerlink" title="回收已用的簇"></a>回收已用的簇</h3><p>​    在fat表中，从被删除文件的首簇开始，将每个fat项置为00，实际文件扇区内容不用修改，这应该就是所谓的标记删除了吧，所以我们可以找到e5打头的目录项尝试恢复文件嘿嘿~</p>
<h3 id="如何创建一个文件"><a href="#如何创建一个文件" class="headerlink" title="如何创建一个文件"></a>如何创建一个文件</h3><p>1、创建文件时，需要首先定位到文件所在的目录文件，然后查找目录项（以32字节为偏移递增），如果第一个字节为0或e5表示可用。</p>
<p>2、根据文件大小计算出需要的簇数目，然后从fat首部开始（第4个字节），查看值为0的项，如果是则可用。找到第一个为0的项，将其索引值（以0开始）写入步骤1找到的目录项的首簇段。接着搜寻为0的项，将其索引值写入前一步找到的项。这样形成一个链，如果是最后一簇，其对应的簇项的值为fff。</p>
<p>3、填写文件目录项的创建时间，属性，大小等字段。</p>
<h3 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h3><p>用好压2345打开文件系统，就可以直接看到里面的目录、文件，用于直观查看运行效果！但是细节的内容建议使用ultraEdit打开查看文件镜像二/十六进制码，确认格式是否正确。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.huangjunqin.com/2017/06/13/fat12/" data-id="cjn7h1hml000a8ov93nklkoyf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/06/17/Semaphore/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          信号量解决进程的同步与互斥例题集合
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">八月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">七月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">三月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">十二月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">十月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">七月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">六月 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/10/13/information-theory-basis/">『Information and coding theory』熵、相对熵、互信息都是些啥子哟，了解一哈</a>
          </li>
        
          <li>
            <a href="/2018/10/10/iot-and-iota/">转载 | 物联网与『高效的』IOTA</a>
          </li>
        
          <li>
            <a href="/2018/08/16/hoticn-forum/">【IEEE HotICN 2018】记录论坛及会议的key points</a>
          </li>
        
          <li>
            <a href="/2018/07/02/手机定位原理/">手机定位原理</a>
          </li>
        
          <li>
            <a href="/2018/04/23/上交计算机保研/">2018上交计算机保研经验分享</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Junqin Huang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
    <a href="https://huangjunqin.com" class="mobile-nav-link">About</a>
  
</nav>
    

<script src="https://code.jquery.com/jquery-2.0.3.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>